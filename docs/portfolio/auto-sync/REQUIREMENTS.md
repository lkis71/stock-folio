# 매매일지-포트폴리오 자동 동기화 요구사항 정의서

## 문서 정보

**버전:** v1.0
**최종 수정일:** 2024-12-30
**작성자:** Claude Code

## 변경 이력

### v1.0 (2024-12-30)
- 초기 작성
- 매매일지-포트폴리오 자동 동기화 기능 요구사항 정의

---

## 1. 기능 개요

### 1.1 목적
매매일지에 기록한 매수/매도 내역이 포트폴리오에 자동으로 반영되어, 사용자가 별도로 포트폴리오를 관리하지 않아도 실시간으로 보유 현황을 파악할 수 있도록 합니다.

### 1.2 범위
- 매매일지 → 포트폴리오 단방향 동기화
- 수량/평균매입가 기반 포트폴리오 관리
- 기존 직접 입력 방식과 병행 지원

---

## 2. 기능 요구사항

| 기능 ID | 기능명 | 상세 설명 | 우선순위 |
|---------|--------|-----------|----------|
| **FR-001** | 매수 시 자동 추가 | 매수 기록 시 포트폴리오에 종목 자동 추가 또는 수량 증가 | P0 |
| **FR-002** | 평균매입가 계산 | 동일 종목 추가 매수 시 가중 평균 매입가 자동 계산 | P0 |
| **FR-003** | 매도 시 수량 차감 | 매도 기록 시 포트폴리오에서 해당 수량 차감 | P0 |
| **FR-004** | 전량 매도 시 삭제 | 보유 수량이 0이 되면 포트폴리오에서 종목 제거 | P0 |
| **FR-005** | 수정 시 재동기화 | 매매 기록 수정 시 이전 영향 취소 후 새 영향 반영 | P0 |
| **FR-006** | 삭제 시 재동기화 | 매매 기록 삭제 시 해당 영향 취소 | P0 |
| **FR-007** | ~~직접 입력 유지~~ | ~~포트폴리오에서 종목을 직접 추가/수정할 수 있음~~ (v3.0 제거됨) | P1 |
| **FR-008** | 색상 자동 할당 | 신규 종목 추가 시 차트 색상 자동 할당 | P1 |
| **FR-009** | 전체 재계산 | 모든 매매일지를 기반으로 포트폴리오 전체 재구축 (선택) | P2 |

---

## 3. 비기능 요구사항

| 카테고리 | 요구사항 | 목표 값 |
|----------|----------|---------|
| **성능** | 동기화 처리 시간 | 100ms 이내 |
| **성능** | 전체 재계산 시간 | 1,000건 기준 1초 이내 |
| **안정성** | 데이터 정합성 | 매매일지 ↔ 포트폴리오 불일치 0% |
| **사용성** | 자동 동기화 | 사용자 추가 조작 불필요 |
| **호환성** | 레거시 데이터 | 기존 금액 기반 데이터 자동 변환 |
| **확장성** | 실시간 시세 연동 | 향후 확장 가능한 구조 |

---

## 4. 데이터 모델

### 4.1 StockHoldingEntity (확장)

| 속성명 | 타입 | 설명 | 비고 |
|--------|------|------|------|
| id | UUID | 고유 식별자 | PK |
| stockName | String | 종목명 | 인덱스 |
| **quantity** | Int | 보유 수량 | **신규** |
| **averagePrice** | Double | 평균 매입가 | **신규** |
| purchaseAmount | Double | 총 투자금액 (계산) | quantity × averagePrice |
| colorName | String | 차트 색상 | |
| createdAt | Date | 생성일시 | |

### 4.2 TradingJournalEntity (기존)

| 속성명 | 타입 | 설명 |
|--------|------|------|
| id | UUID | 고유 식별자 |
| tradeType | TradeType | 매수/매도 |
| tradeDate | Date | 거래일 |
| stockName | String | 종목명 |
| quantity | Int | 거래 수량 |
| price | Double | 거래 단가 |
| realizedProfit | Double | 실현 손익 |
| reason | String | 매매 사유 |

### 4.3 동기화 규칙

| 매매 유형 | 포트폴리오 변경 | 계산식 |
|----------|----------------|--------|
| 매수 (신규) | 종목 추가 | quantity=매수수량, avgPrice=매수가 |
| 매수 (추가) | 수량/평균가 업데이트 | newAvg = (기존금액 + 신규금액) / (기존수량 + 신규수량) |
| 매도 (부분) | 수량 차감 | quantity = 기존수량 - 매도수량 |
| 매도 (전량) | 종목 삭제 | 수량 ≤ 0 시 삭제 |
| 수정 | 이전 취소 → 새 적용 | 역방향 처리 후 정방향 처리 |
| 삭제 | 영향 취소 | 역방향 처리 |

---

## 5. 제약사항

| 항목 | 제약 내용 |
|------|-----------|
| 종목명 | 매매일지와 포트폴리오 간 동일 종목명으로 매칭 |
| 매도 수량 | 보유 수량 초과 매도 시 보유 수량만큼만 차감 |
| 색상 유지 | 기존 종목의 색상은 동기화 시 변경하지 않음 |
| 직접 입력 | 직접 입력한 종목은 매매일지에 기록되지 않음 |

---

## 6. 개발 우선순위

| Phase | 기능 ID | 기능명 | 우선순위 | 비고 |
|-------|---------|--------|----------|------|
| **Phase 1** | FR-001 ~ FR-006 | 핵심 동기화 로직 | P0 | **완료** |
| **Phase 2** | FR-007, FR-008 | UI 개선 | P1 | **완료** |
| **Phase 3** | FR-009 | 전체 재계산 | P2 | 선택 |

---

## 7. 구현 컴포넌트

### 7.1 신규 생성

| 컴포넌트 | 역할 | 파일 |
|----------|------|------|
| PortfolioSyncService | 동기화 로직 담당 | `Services/PortfolioSyncService.swift` |
| PortfolioSyncServiceProtocol | 테스트용 프로토콜 | 위 파일에 포함 |

### 7.2 수정

| 컴포넌트 | 변경 내용 |
|----------|----------|
| StockHoldingEntity | quantity, averagePrice 속성 추가 |
| StockRepositoryProtocol | fetchByStockName, upsert, deleteByStockName 메서드 추가 |
| CoreDataStockRepository | 신규 메서드 구현 |
| TradingJournalViewModel | 동기화 서비스 연동 |
| PortfolioViewModel | 수량/평균가 기반 메서드 추가 |
| StockRowView | 수량/평균가 표시 |
| AddStockView | 수량/평균가 입력 폼 |
